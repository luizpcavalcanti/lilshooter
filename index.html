<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Updated JS Arena</title>
<style>
    body {
        margin: 0;
        background: #111;
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
    }
    canvas {
        border: 0.5rem outset pink;
        background: #222;
    }
</style>
</head>
<body>

<canvas id="ctx" width="800" height="800"></canvas>

<!-- Audio -->
<audio id="shoot" src="./sounds/shoot.wav"></audio>
<audio id="bigshoot" src="./sounds/bigshoot.wav"></audio>
<audio id="supershoot" src="./sounds/supershoot.wav"></audio>
<audio id="powerup" src="./sounds/powerup.wav"></audio>
<audio id="coin" src="./sounds/coin.wav"></audio>
<audio id="hit" src="./sounds/hit.wav"></audio>

<script>
// ==========================================================
// GLOBAL
// ==========================================================

const canvas = document.getElementById("ctx");
const ctx = canvas.getContext("2d");

const WIDTH = 800;
const HEIGHT = 800;

let timeWhenStarted = Date.now();
let frameCount = 0;
let score = 0;

let player;
let enemies = {};
let upgrades = {};
let bullets = {};

// ==========================================================
// HELPERS
// ==========================================================

function randomRange(min, max) {
    return Math.random() * (max - min) + min;
}

function dist(e1, e2) {
    const dx = e1.x - e2.x;
    const dy = e1.y - e2.y;
    return Math.sqrt(dx * dx + dy * dy);
}

function rectCollision(a, b) {
    return (
        a.x - a.width/2 < b.x + b.width/2 &&
        a.x + a.width/2 > b.x - b.width/2 &&
        a.y - a.height/2 < b.y + b.height/2 &&
        a.y + a.height/2 > b.y - b.height/2
    );
}

// ==========================================================
// PLAYER
// ==========================================================

function createPlayer() {
    player = {
        type: "player",
        x: WIDTH / 2,
        y: HEIGHT / 2,
        width: 20,
        height: 20,
        hp: 10,
        color: "LightGreen",
        atkSpeed: 1,
        atkCounter: 0,
        AimAngle: 0,
        pressing: { up: false, down: false, left: false, right: false }
    };
}

// ==========================================================
// ENEMY
// ==========================================================

function spawnEnemy() {
    const id = Math.random();
    enemies[id] = {
        type: "enemy",
        id,
        x: randomRange(0, WIDTH),
        y: randomRange(0, HEIGHT),
        width: randomRange(10, 35),
        height: randomRange(10, 35),
        xs: randomRange(3, 8),
        ys: randomRange(3, 8),
        color: "Maroon"
    };
}

// ==========================================================
// UPGRADES
// ==========================================================

function spawnUpgrade() {
    const id = Math.random();
    const isAtk = Math.random() < 0.5;

    upgrades[id] = {
        type: "upgrade",
        id,
        x: randomRange(0, WIDTH),
        y: randomRange(0, HEIGHT),
        width: 13,
        height: 13,
        xs: 0,
        ys: 0,
        category: isAtk ? "atkSpeed" : "low",
        color: isAtk ? "blueviolet" : "khaki"
    };
}

// ==========================================================
// BULLETS
// ==========================================================

function spawnBullet(origin, angleOverride) {
    const id = Math.random();
    const angle = angleOverride !== undefined ? angleOverride : origin.AimAngle;

    bullets[id] = {
        type: "bullet",
        id,
        x: origin.x,
        y: origin.y,
        width: 5,
        height: 5,
        timer: 0,
        color: "black",
        xs: Math.cos(angle * Math.PI / 180) * 15,
        ys: Math.sin(angle * Math.PI / 180) * 15
    };
}

// ==========================================================
// DRAW + UPDATE
// ==========================================================

function draw(e) {
    ctx.fillStyle = e.color;
    ctx.fillRect(e.x - e.width/2, e.y - e.height/2, e.width, e.height);
}

function move(e) {
    if (e.type === "player") {
        if (player.pressing.right) e.x += 8;
        if (player.pressing.left) e.x -= 8;
        if (player.pressing.up) e.y -= 8;
        if (player.pressing.down) e.y += 8;

        e.x = Math.max(e.width/2, Math.min(WIDTH - e.width/2, e.x));
        e.y = Math.max(e.height/2, Math.min(HEIGHT - e.height/2, e.y));
    } else {
        e.x += e.xs;
        e.y += e.ys;

        if (e.x < 0 || e.x > WIDTH) e.xs *= -1;
        if (e.y < 0 || e.y > HEIGHT) e.ys *= -1;
    }
}

// ==========================================================
// INPUT
// ==========================================================

document.onmousemove = e => {
    const rect = canvas.getBoundingClientRect();
    const mx = e.clientX - rect.left - player.x;
    const my = e.clientY - rect.top - player.y;
    player.AimAngle = Math.atan2(my, mx) * 180 / Math.PI;
};

document.onclick = () => {
    if (player.atkCounter > 50) {
        shoot.play();
        player.atkCounter -= 25;
        spawnBullet(player);
    }
};

document.oncontextmenu = e => {
    e.preventDefault();

    if (player.atkCounter > 500) {
        supershoot.play();
        for (let a = 0; a < 360; a += 9) spawnBullet(player, a);
        player.atkCounter = 0;
        return;
    }

    if (player.atkCounter > 50) {
        bigshoot.play();
        player.atkCounter -= 50;
        spawnBullet(player, player.AimAngle + 15);
        spawnBullet(player, player.AimAngle + 5);
        spawnBullet(player);
        spawnBullet(player, player.AimAngle - 5);
        spawnBullet(player, player.AimAngle - 15);
    }
};

document.onkeydown = e => {
    if (e.key === "d") player.pressing.right = true;
    if (e.key === "a") player.pressing.left = true;
    if (e.key === "w") player.pressing.up = true;
    if (e.key === "s") player.pressing.down = true;
};

document.onkeyup = e => {
    if (e.key === "d") player.pressing.right = false;
    if (e.key === "a") player.pressing.left = false;
    if (e.key === "w") player.pressing.up = false;
    if (e.key === "s") player.pressing.down = false;
};

// ==========================================================
// GAME LOOP
// ==========================================================

function update() {
    ctx.clearRect(0, 0, WIDTH, HEIGHT);
    frameCount++;
    score++;
    player.atkCounter += player.atkSpeed;

    // player color feedback
    if (player.atkCounter >= 520) player.color = "Yellow";
    else if (player.atkCounter >= 250) player.color = "LawnGreen";
    else if (player.atkCounter >= 50) player.color = "Lime";
    else player.color = "LightGreen";

    // spawn logic
    if (frameCount % 80 === 0) spawnEnemy();
    if (frameCount % 75 === 0) spawnUpgrade();

    // update enemies
    for (const id in enemies) {
        const e = enemies[id];
        move(e);
        draw(e);

        if (rectCollision(player, e)) {
            player.hp--;
            hit.play();
        }
    }

    // update upgrades
    for (const id in upgrades) {
        const u = upgrades[id];
        move(u);
        draw(u);

        if (rectCollision(player, u)) {
            if (u.category === "low") {
                score += 1000;
                coin.play();
            } else if (u.category === "atkSpeed") {
                player.atkSpeed++;
                powerup.play();
            }
            delete upgrades[id];
        }
    }

    // update bullets
    for (const id in bullets) {
        const b = bullets[id];
        b.timer++;
        b.x += b.xs;
        b.y += b.ys;

        draw(b);

        if (b.timer > 40) {
            delete bullets[id];
            continue;
        }

        for (const eid in enemies) {
            const e = enemies[eid];

            if (rectCollision(b, e)) {
                delete bullets[id];
                hit.play();

                e.width -= 4;
                e.height -= 4;

                if (e.width <= 12 || e.height <= 12) delete enemies[eid];
                break;
            }
        }
    }

    // player dead
    if (player.hp <= 0) {
        const t = (Date.now() - timeWhenStarted) / 1000;
        alert("GAME OVER - Survived " + t + "s - Score = " + score);
        startGame();
        return;
    }

    move(player);
    draw(player);

    ctx.fillStyle = "white";
    ctx.fillText(player.hp + " HP", 12, 25);
    ctx.fillText("Score: " + score, 200, 25);
}

function startGame() {
    createPlayer();
    frameCount = 0;
    score = 0;
    timeWhenStarted = Date.now();
    enemies = {};
    upgrades = {};
    bullets = {};
    spawnEnemy();
    spawnEnemy();
    spawnEnemy();
}

startGame();
setInterval(update, 50);
</script>

</body>
</html>
